name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_pages:
        description: Deploy to Cloudflare Pages
        type: boolean
        default: true
      run_migrations:
        description: Run DB migrations (requires DATABASE_URL secret)
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}  # Backward compatibility
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}  # New standard
      CF_PROJECT_NAME: ${{ secrets.CF_PROJECT_NAME }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '>=1.22.0'
      - name: Download deps
        run: go mod download
      - name: Export static site (SSG)
        run: go run ./cmd/gforge export -o dist
        env:
          GFORGE_SKIP_TOOLS: ""
          LOG_FORMAT: off
      - name: Run DB migrations
        if: ${{ inputs.run_migrations && env.DATABASE_URL != '' }}
        run: go run ./cmd/gforge db --migrate
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
      - name: Deploy to Cloudflare Pages
        if: ${{ inputs.deploy_pages && (env.CLOUDFLARE_API_TOKEN != '' || env.CF_API_TOKEN != '') && (env.CLOUDFLARE_ACCOUNT_ID != '' || env.CF_ACCOUNT_ID != '') && env.CF_PROJECT_NAME != '' }}
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN || env.CF_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID || env.CF_ACCOUNT_ID }}
          projectName: ${{ env.CF_PROJECT_NAME }}
          directory: dist
          gitHubToken: ${{ env.GITHUB_TOKEN }}
      - name: Deployment complete
        run: |
          echo "‚úÖ Static site deployed to Cloudflare Pages"
          echo "üìù Note: Back4app Containers auto-deploy from GitHub pushes"
          echo "üîó View logs at https://dashboard.back4app.com"
